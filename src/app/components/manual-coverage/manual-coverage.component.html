<!-- manual-coverage.component.html - Enhanced version with Statistics Edit -->
<div class="manual-coverage-container">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="card header-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title mb-2">
                                <i class="fab fa-jira me-2"></i>
                                Manual Coverage - Jira Integration
                            </h2>
                            <p class="card-text text-muted">
                                Link Jira issues with QTest cases and manage automation
                                readiness
                            </p>
                        </div>
                        <div class="connection-status">
                            <button
                                    (click)="testConnection()"
                                    [disabled]="loading"
                                    class="btn btn-outline-primary"
                            >
                <span
                        *ngIf="loading"
                        class="spinner-border spinner-border-sm me-2"
                ></span>
                                <i *ngIf="!loading" class="fas fa-plug me-2"></i>
                                Test Connection
                            </button>
                            <div *ngIf="connectionStatus" class="mt-2">
                <span
                        [class]="
                    connectionStatus.connected ? 'bg-success' : 'bg-danger'
                  "
                        class="badge"
                >
                  <i
                          [class]="
                      connectionStatus.connected ? 'fa-check' : 'fa-times'
                    "
                          class="fas"
                  ></i>
                  {{ connectionStatus.message }}
                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs nav-tabs-custom">
                <li class="nav-item">
                    <a
                            (click)="setActiveTab('sprints')"
                            [class.active]="activeTab === 'sprints'"
                            class="nav-link"
                            style="cursor: pointer"
                    >
                        <i class="fas fa-calendar-alt me-2"></i>
                        Sprints
                    </a>
                </li>
                <li class="nav-item">
                    <a
                            (click)="setActiveTab('issues')"
                            [class.active]="activeTab === 'issues'"
                            [class.disabled]="!selectedSprint"
                            class="nav-link"
                            style="cursor: pointer"
                    >
                        <i class="fas fa-tasks me-2"></i>
                        Issues
                        <span *ngIf="selectedSprint" class="badge bg-primary ms-2">
              {{ jiraIssues.length }}
            </span>
                    </a>
                </li>
                <li class="nav-item">
                    <a
                            (click)="setActiveTab('statistics')"
                            [class.active]="activeTab === 'statistics'"
                            [class.disabled]="!sprintStatistics"
                            class="nav-link"
                            style="cursor: pointer"
                    >
                        <i class="fas fa-chart-bar me-2"></i>
                        Statistics
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="row mt-4">
        <div class="col-12">
            <!-- Sprints Tab -->
            <div *ngIf="activeTab === 'sprints'" class="tab-content-card">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>
                                Available Sprints
                            </h5>

                            <!-- Sprint View Toggle -->
                            <div class="sprint-controls">
                                <div class="form-check form-check-inline">
                                    <input
                                            (change)="showAllSprints = false; onSprintViewToggle()"
                                            [checked]="!showAllSprints"
                                            class="form-check-input"
                                            id="activeSprintOnly"
                                            name="sprintView"
                                            type="radio"
                                    />
                                    <label class="form-check-label" for="activeSprintOnly">
                                        Active Sprint Only
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input
                                            (change)="showAllSprints = true; onSprintViewToggle()"
                                            [checked]="showAllSprints"
                                            class="form-check-input"
                                            id="allSprints"
                                            name="sprintView"
                                            type="radio"
                                    />
                                    <label class="form-check-label" for="allSprints">
                                        All Sprints
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Domain and Project Filters -->
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label" for="domainFilter"
                                >Filter by Domain</label
                                >
                                <select
                                        [(ngModel)]="selectedDomain"
                                        class="form-select form-select-sm"
                                        id="domainFilter"
                                >
                                    <option [ngValue]="null">All Domains</option>
                                    <option *ngFor="let domain of domains" [ngValue]="domain">
                                        {{ domain.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="projectFilter"
                                >Filter by Project</label
                                >
                                <select
                                        (change)="onProjectChange()"
                                        [(ngModel)]="selectedProjectForSprints"
                                        [disabled]="!selectedDomain"
                                        class="form-select form-select-sm"
                                        id="projectFilter"
                                >
                                    <option [ngValue]="null">All Projects</option>
                                    <option
                                            *ngFor="let project of filteredProjectsForSprints"
                                            [ngValue]="project"
                                    >
                                        {{ project.name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div *ngIf="filteredSprints.length > 0; else noSprints" class="row">
                            <div
                                    *ngFor="let sprint of filteredSprints"
                                    class="col-lg-4 col-md-6 mb-3"
                            >
                                <div
                                        (click)="selectSprint(sprint)"
                                        [class.selected]="selectedSprint?.id === sprint.id"
                                        class="card sprint-card"
                                >
                                    <div class="card-body">
                                        <div
                                                class="d-flex justify-content-between align-items-start mb-2"
                                        >
                                            <h6 class="card-title mb-0">{{ sprint.name }}</h6>
                                            <span
                                                    [class]="getSprintStateColor(sprint.state)"
                                                    class="badge"
                                            >
                        {{ sprint.state }}
                      </span>
                                        </div>
                                        <div class="sprint-details">
                                            <p class="text-muted mb-1">
                                                <i class="fas fa-play me-1"></i>
                                                <small>{{ sprint.startDate | date: "short" }}</small>
                                            </p>
                                            <p class="text-muted mb-0">
                                                <i class="fas fa-stop me-1"></i>
                                                <small>{{ sprint.endDate | date: "short" }}</small>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <ng-template #noSprints>
                            <div class="no-data">
                                <i class="fas fa-calendar-times text-muted"></i>
                                <h5 class="mt-3 text-muted">No sprints available</h5>
                                <p class="text-muted">
                                    Check your Jira connection or ensure sprints exist in your
                                    configured board.
                                </p>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </div>

            <!-- Issues Tab -->
            <div *ngIf="activeTab === 'issues'" class="tab-content-card">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-tasks me-2"></i>
                                Issues in {{ selectedSprint?.name }}
                                <span class="badge bg-info ms-2">{{
                  filteredIssues.length
                }}</span>
                            </h5>

                            <!-- Search and Filters -->
                            <div class="filter-controls">
                                <!-- Global Search Section -->
                                <div class="global-search-section me-3">
                                    <div class="global-search-container">
                                        <label class="form-label small mb-1"
                                        >Global Search Across All Jira Tickets</label
                                        >
                                        <div class="input-group global-search-group">
                                            <input
                                                    (keyup.enter)="performGlobalSearch()"
                                                    [(ngModel)]="globalSearchKeyword"
                                                    [disabled]="globalSearchLoading"
                                                    class="form-control form-control-sm"
                                                    placeholder="Enter keyword to search all tickets..."
                                                    type="text"
                                            />
                                            <button
                                                    (click)="performGlobalSearch()"
                                                    [disabled]="!globalSearchKeyword || globalSearchLoading"
                                                    class="btn btn-outline-primary btn-sm"
                                                    type="button"
                                            >
                        <span
                                *ngIf="globalSearchLoading"
                                class="spinner-border spinner-border-sm"
                        ></span>
                                                <i
                                                        *ngIf="!globalSearchLoading"
                                                        class="fas fa-search"
                                                ></i>
                                            </button>
                                        </div>
                                        <div class="form-check form-check-inline mt-1">
                                            <input
                                                    [(ngModel)]="searchCurrentSprintOnly"
                                                    class="form-check-input"
                                                    id="searchCurrentSprintOnly"
                                                    type="checkbox"
                                            />
                                            <label
                                                    class="form-check-label small"
                                                    for="searchCurrentSprintOnly"
                                            >
                                                Limit to current sprint
                                            </label>
                                        </div>

                                        <!-- Global Search Results -->
                                        <div
                                                *ngIf="globalSearchResult"
                                                class="global-search-results mt-2"
                                        >
                                            <!-- Summary Badge -->
                                            <div class="search-summary-badge">
                                                <div
                                                        [class]="
                            (globalSearchResult.totalOccurrences || 0) > 0
                              ? 'success'
                              : 'warning'
                          "
                                                        class="badge-container"
                                                >
                                                    <div class="badge-content">
                                                        <i class="fas fa-search me-2"></i>
                                                        <span class="search-count">{{
                              globalSearchResult.totalOccurrences || 0
                            }}</span>
                                                        <span class="search-text">
                              <span
                                      *ngIf="
                                  (globalSearchResult.totalOccurrences || 0) ===
                                  1
                                "
                              >occurrence</span
                              >
                              <span
                                      *ngIf="
                                  (globalSearchResult.totalOccurrences || 0) !==
                                  1
                                "
                              >occurrences</span
                              >
                              of
                            </span>
                                                        <span class="keyword-highlight"
                                                        >"{{ globalSearchResult.keyword }}"</span
                                                        >
                                                        <span class="ms-2 text-muted small">
                              across
                              {{ globalSearchResult.totalCount || 0 }} issues
                            </span>
                                                        <button
                                                                (click)="toggleGlobalSearchDetails()"
                                                                *ngIf="
                                (globalSearchResult.totalOccurrences || 0) > 0
                              "
                                                                class="btn btn-sm btn-link details-toggle p-0 ms-2"
                                                        >
                                                            <i
                                                                    [class]="
                                  showGlobalSearchDetails
                                    ? 'fa-chevron-up'
                                    : 'fa-chevron-down'
                                "
                                                                    class="fas"
                                                            ></i>
                                                        </button>
                                                        <button
                                                                (click)="clearGlobalSearchResults()"
                                                                class="btn btn-sm btn-link close-btn p-0 ms-2"
                                                        >
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Detailed Results -->
                                            <div
                                                    *ngIf="
                          showGlobalSearchDetails &&
                          globalSearchResult.matchingIssues &&
                          globalSearchResult.matchingIssues.length > 0
                        "
                                                    class="search-details mt-3"
                                            >
                                                <div class="details-container">
                                                    <h6 class="details-header">
                                                        <i class="fas fa-list-ul me-2"></i>
                                                        Quick Preview ({{
                                                        globalSearchResult.matchingIssues.length
                                                        }}
                                                        issues)
                                                    </h6>
                                                    <div class="details-list">
                                                        <div
                                                                *ngFor="
                                let detail of globalSearchResult.matchingIssues.slice(
                                  0,
                                  5
                                );
                                let i = index
                              "
                                                                class="detail-item"
                                                        >
                                                            <div class="item-header">
                                                                <div class="issue-info">
                                  <span class="issue-key">{{
                                    detail.key
                                  }}</span>
                                                                    <span class="issue-summary">{{
                                    detail.summary
                                  }}</span>
                                                                </div>
                                                                <div class="occurrence-count">
                                  <span class="badge bg-primary">
                                    {{ detail.occurrences }}
                                    <span *ngIf="detail.occurrences === 1"
                                    >match</span
                                    >
                                    <span *ngIf="detail.occurrences !== 1"
                                    >matches</span
                                    >
                                  </span>
                                                                </div>
                                                            </div>
                                                            <div
                                                                    *ngIf="detail.status || detail.priority"
                                                                    class="item-meta"
                                                            >
                                <span
                                        [class]="
                                    'status-' +
                                    (detail.status || '')
                                      .toLowerCase()
                                      .replace(' ', '-')
                                  "
                                        class="status-badge"
                                >
                                  {{ detail.status }}
                                </span>
                                                                <span
                                                                        [class]="
                                    'priority-' +
                                    (detail.priority || '').toLowerCase()
                                  "
                                                                        class="priority-badge"
                                                                >
                                  {{ detail.priority }}
                                </span>
                                                            </div>
                                                        </div>
                                                        <div
                                                                *ngIf="
                                globalSearchResult.matchingIssues.length > 5
                              "
                                                                class="text-center mt-2"
                                                        >
                                                            <small class="text-muted">
                                                                View complete results in Statistics tab
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Local Search Section -->
                                <div class="search-box me-3">
                                    <label class="form-label small mb-1"
                                    >Filter Current Issues</label
                                    >
                                    <div class="position-relative">
                                        <input
                                                [(ngModel)]="searchTerm"
                                                class="form-control form-control-sm"
                                                placeholder="Search current issues..."
                                                type="text"
                                        />
                                        <i class="fas fa-search search-icon"></i>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <select
                                            [(ngModel)]="statusFilter"
                                            class="form-select form-select-sm"
                                    >
                                        <option value="">All Status</option>
                                        <option
                                                *ngFor="let status of uniqueStatuses"
                                                [value]="status"
                                        >
                                            {{ status }}
                                        </option>
                                    </select>

                                    <select
                                            [(ngModel)]="priorityFilter"
                                            class="form-select form-select-sm"
                                    >
                                        <option value="">All Priority</option>
                                        <option
                                                *ngFor="let priority of uniquePriorities"
                                                [value]="priority"
                                        >
                                            {{ priority }}
                                        </option>
                                    </select>

                                    <button
                                            (click)="resetFilters()"
                                            class="btn btn-outline-secondary btn-sm"
                                    >
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body p-0">
                        <div
                                *ngIf="paginatedIssues.length > 0; else noIssues"
                                class="table-responsive"
                        >
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th
                                            (click)="sortBy('jiraKey')"
                                            class="col-issue"
                                            style="cursor: pointer"
                                    >
                                        Issue
                                        <i [class]="getSortIcon('jiraKey')"></i>
                                    </th>
                                    <th
                                            (click)="sortBy('summary')"
                                            class="col-summary"
                                            style="cursor: pointer"
                                    >
                                        Summary
                                        <i [class]="getSortIcon('summary')"></i>
                                    </th>
                                    <th
                                            (click)="sortBy('status')"
                                            class="col-status"
                                            style="cursor: pointer"
                                    >
                                        Status
                                        <i [class]="getSortIcon('status')"></i>
                                    </th>
                                    <th
                                            (click)="sortBy('priority')"
                                            class="col-priority"
                                            style="cursor: pointer"
                                    >
                                        Priority
                                        <i [class]="getSortIcon('priority')"></i>
                                    </th>
                                    <th
                                            (click)="sortBy('linkedTestCases')"
                                            class="col-testcases"
                                            style="cursor: pointer"
                                    >
                                        Test Cases
                                        <i [class]="getSortIcon('linkedTestCases')"></i>
                                    </th>
                                    <th
                                            (click)="sortBy('keywordCount')"
                                            class="col-keywords"
                                            style="cursor: pointer"
                                    >
                                        Keywords
                                        <i [class]="getSortIcon('keywordCount')"></i>
                                    </th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr *ngFor="let issue of paginatedIssues">
                                    <td>
                                        <strong>{{ issue.jiraKey }}</strong>
                                        <div class="text-muted small">{{ issue.issueType }}</div>
                                    </td>
                                    <td>
                                        <div class="issue-summary">{{ issue.summary }}</div>
                                    </td>
                                    <td>
                      <span
                              [class]="getStatusColor(issue.status)"
                              class="badge"
                      >
                        {{ issue.status }}
                      </span>
                                    </td>
                                    <td>
                      <span
                              [class]="getPriorityColor(issue.priority)"
                              class="badge"
                      >
                        {{ issue.priority }}
                      </span>
                                    </td>
                                    <td>
                                        <div class="test-cases-column">
                                            <div class="d-flex align-items-center">
                          <span class="badge bg-primary me-2">{{
                            issue.linkedTestCases.length
                          }}</span>
                                                <div
                                                        *ngIf="
                              issue.linkedTestCases.length > 0 &&
                              showTestCaseOptions
                            "
                                                        class="btn-group"
                                                >
                                                    <button
                                                            class="btn btn-sm btn-outline-info dropdown-toggle"
                                                            data-bs-toggle="dropdown"
                                                            type="button"
                                                    >
                                                        View
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li
                                                                *ngFor="let testCase of issue.linkedTestCases"
                                                        >
                                                            <a
                                                                    (click)="openTestCaseModal(testCase, issue)"
                                                                    class="dropdown-item"
                                                                    style="cursor: pointer"
                                                            >
                                                                {{ testCase.qtestTitle }}
                                                                <span
                                                                        [class]="
                                      getAutomationStatusColor(
                                        testCase.automationStatus
                                      )
                                    "
                                                                        class="badge ms-2"
                                                                >
                                    {{
                                      getAutomationStatusDisplay(
                                        testCase.automationStatus
                                      )
                                    }}
                                  </span>
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                      <span
                              *ngIf="issue.keywordCount > 0"
                              class="badge bg-warning"
                      >
                        {{ issue.keywordCount }}
                      </span>
                                        <span *ngIf="issue.keywordCount === 0" class="text-muted"
                                        >0</span
                                        >
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button
                                                    (click)="openKeywordModal(issue)"
                                                    class="btn btn-sm btn-outline-primary"
                                                    title="Search Keywords"
                                            >
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <ng-template #noIssues>
                            <div class="no-data">
                                <i class="fas fa-tasks text-muted"></i>
                                <h5 class="mt-3 text-muted">No issues found</h5>
                                <p class="text-muted">
                                    {{
                                    searchTerm
                                    ? "No issues match your search criteria"
                                    : "No issues found in this sprint"
                                    }}
                                </p>
                            </div>
                        </ng-template>

                        <!-- Pagination -->
                        <div
                                *ngIf="totalPages > 1"
                                class="d-flex justify-content-between align-items-center p-3"
                        >
                            <div class="text-muted">
                                Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to
                                {{
                                Math.min(currentPage * itemsPerPage, filteredIssues.length)
                                }}
                                of {{ filteredIssues.length }} issues
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    <li [class.disabled]="currentPage === 1" class="page-item">
                                        <a
                                                (click)="goToPage(currentPage - 1)"
                                                class="page-link"
                                                style="cursor: pointer"
                                        >Previous</a
                                        >
                                    </li>
                                    <li
                                            *ngFor="
                      let page of [].constructor(totalPages);
                      let i = index
                    "
                                            [class.active]="currentPage === i + 1"
                                            class="page-item"
                                    >
                                        <a
                                                (click)="goToPage(i + 1)"
                                                class="page-link"
                                                style="cursor: pointer"
                                        >{{ i + 1 }}</a
                                        >
                                    </li>
                                    <li
                                            [class.disabled]="currentPage === totalPages"
                                            class="page-item"
                                    >
                                        <a
                                                (click)="goToPage(currentPage + 1)"
                                                class="page-link"
                                                style="cursor: pointer"
                                        >Next</a
                                        >
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Statistics Tab with Edit Functionality -->
            <div *ngIf="activeTab === 'statistics'" class="tab-content-card">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Sprint Statistics - {{ selectedSprint?.name }}
                        </h5>
                    </div>
                    <div *ngIf="sprintStatistics" class="card-body">
                        <!-- Overall Stats -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value">
                                        {{ sprintStatistics.totalTestCases }}
                                    </div>
                                    <div class="stat-label">Total Test Cases</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card ready">
                                    <div class="stat-value">
                                        {{ sprintStatistics.readyToAutomate }}
                                    </div>
                                    <div class="stat-label">Ready to Automate</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card danger">
                                    <div class="stat-value">
                                        {{ sprintStatistics.notAutomatable }}
                                    </div>
                                    <div class="stat-label">Not Automatable</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card warning">
                                    <div class="stat-value">{{ sprintStatistics.pending }}</div>
                                    <div class="stat-label">Pending</div>
                                </div>
                            </div>
                        </div>

                        <!-- Global Search Results Table -->
                        <div
                                *ngIf="
                globalSearchResult &&
                (globalSearchResult.totalOccurrences || 0) > 0
              "
                                class="global-search-results-table mb-4"
                        >
                            <h6 class="mb-3">
                                <i class="fas fa-search me-2"></i>
                                Global Search Results for "{{ globalSearchResult.keyword }}"
                            </h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="stat-card">
                                        <div class="stat-value">
                                            {{ globalSearchResult.totalOccurrences || 0 }}
                                        </div>
                                        <div class="stat-label">Total Occurrences</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stat-card">
                                        <div class="stat-value">
                                            {{ globalSearchResult.totalCount || 0 }}
                                        </div>
                                        <div class="stat-label">Total Issues</div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                    <tr>
                                        <th>JIRA Key</th>
                                        <th>Summary</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Occurrences</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr *ngFor="let issue of globalSearchResult.matchingIssues">
                                        <td>
                                            <strong class="text-primary">{{ issue.key }}</strong>
                                        </td>
                                        <td>
                                            <div class="issue-summary-text">
                                                {{ issue.summary }}
                                            </div>
                                        </td>
                                        <td>
                        <span class="badge bg-secondary">{{
                          issue.issueType
                        }}</span>
                                        </td>
                                        <td>
                        <span
                                [class]="getStatusColor(issue.status)"
                                class="badge"
                        >
                          {{ issue.status }}
                        </span>
                                        </td>
                                        <td>
                        <span
                                [class]="getPriorityColor(issue.priority)"
                                class="badge"
                        >
                          {{ issue.priority }}
                        </span>
                                        </td>
                                        <td>
                        <span class="badge bg-info">{{
                          issue.occurrences
                        }}</span>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Enhanced Test Cases Overview Table with Edit Actions -->
                        <div class="test-cases-overview">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-table me-2"></i>
                                            Test Cases Overview - {{ selectedSprint?.name }}
                                            <span class="badge bg-primary ms-2">{{ filteredStatisticsTestCases.length }}</span>
                                        </h6>

                                        <!-- Filter Controls for Statistics Table -->
                                        <div class="filter-controls d-flex gap-2 align-items-center">
                                            <select
                                                    (change)="applyStatisticsFilters()"
                                                    [(ngModel)]="statisticsStatusFilter"
                                                    class="form-select form-select-sm"
                                                    style="width: auto;"
                                            >
                                                <option value="">All Status</option>
                                                <option value="READY_TO_AUTOMATE">Ready to Automate</option>
                                                <option value="NOT_AUTOMATABLE">Cannot be Automated</option>
                                                <option value="PENDING">Pending</option>
                                            </select>

                                            <select
                                                    (change)="applyStatisticsFilters()"
                                                    [(ngModel)]="statisticsProjectFilter"
                                                    class="form-select form-select-sm"
                                                    style="width: auto;"
                                            >
                                                <option value="">All Projects</option>
                                                <option *ngFor="let project of projects" [value]="project.id">
                                                    {{ project.name }}
                                                </option>
                                            </select>

                                            <div class="position-relative">
                                                <input
                                                        (input)="applyStatisticsFilters()"
                                                        [(ngModel)]="statisticsSearchTerm"
                                                        class="form-control form-control-sm"
                                                        placeholder="Search test cases..."
                                                        style="width: 200px;"
                                                        type="text"
                                                />
                                                <i class="fas fa-search position-absolute top-50 end-0 translate-middle-y me-2 text-muted"></i>
                                            </div>

                                            <button
                                                    (click)="resetStatisticsFilters()"
                                                    class="btn btn-outline-secondary btn-sm"
                                            >
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="card-body p-0">
                                    <div *ngIf="paginatedStatisticsTestCases.length > 0; else noStatisticsTestCases"
                                         class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                            <tr>
                                                <th (click)="sortStatisticsTable('qtestTitle')" class="col-title sortable"
                                                    style="cursor: pointer;">
                                                    Test Case Title <i
                                                        [class]="getStatisticsSortIcon('qtestTitle')"></i>
                                                </th>
                                                <th (click)="sortStatisticsTable('projectName')" class="col-project sortable"
                                                    style="cursor: pointer;">
                                                    Project <i [class]="getStatisticsSortIcon('projectName')"></i>
                                                </th>
                                                <th (click)="sortStatisticsTable('automationStatus')" class="col-status sortable"
                                                    style="cursor: pointer;">
                                                    Automation Status <i
                                                        [class]="getStatisticsSortIcon('automationStatus')"></i>
                                                </th>
                                                <th (click)="sortStatisticsTable('assignedTesterName')" class="col-tester sortable"
                                                    style="cursor: pointer;">
                                                    Assigned Tester <i
                                                        [class]="getStatisticsSortIcon('assignedTesterName')"></i>
                                                </th>
                                                <th (click)="sortStatisticsTable('manualTesterName')" class="col-manual-tester sortable"
                                                    style="cursor: pointer;">
                                                    Manual Tester <i
                                                        [class]="getStatisticsSortIcon('manualTesterName')"></i>
                                                </th>
                                                <th (click)="sortStatisticsTable('testCaseType')" class="col-type sortable"
                                                    style="cursor: pointer;">
                                                    Type <i [class]="getStatisticsSortIcon('testCaseType')"></i>
                                                </th>
                                                <th (click)="sortStatisticsTable('toolType')" class="col-tool sortable"
                                                    style="cursor: pointer;">
                                                    Tool <i [class]="getStatisticsSortIcon('toolType')"></i>
                                                </th>
                                                <th (click)="sortStatisticsTable('domainMapped')" class="col-domain sortable"
                                                    style="cursor: pointer;">
                                                    Domain <i [class]="getStatisticsSortIcon('domainMapped')"></i>
                                                </th>
                                                <th class="col-jira">Related JIRA</th>
                                                <th *ngIf="showTestCaseOptions" class="col-actions">Actions</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr *ngFor="let testCase of paginatedStatisticsTestCases; trackBy: trackByStatisticsTestCase">
                                                <td class="col-title">
                                                    <div class="test-case-info">
                                                        <div class="fw-semibold text-primary">{{ testCase.qtestTitle
                                                            }}
                                                        </div>
                                                        <small *ngIf="testCase.qtestId" class="text-muted">QTest ID: {{
                                                            testCase.qtestId }}</small>
                                                    </div>
                                                </td>
                                                <td class="col-project">
                                                    <span *ngIf="testCase.projectName" class="badge bg-light text-dark">{{ testCase.projectName }}</span>
                                                    <span *ngIf="!testCase.projectName" class="text-muted">-</span>
                                                </td>
                                                <td class="col-status">
                            <span [class]="getAutomationStatusColor(testCase.automationStatus)" class="badge">
                              {{ getAutomationStatusDisplay(testCase.automationStatus) }}
                            </span>
                                                </td>
                                                <td class="col-tester">
                                                    <div *ngIf="testCase.assignedTesterName; else noAssignedTester">
                                                        <span class="fw-semibold">{{ testCase.assignedTesterName }}</span>
                                                    </div>
                                                    <ng-template #noAssignedTester>
                                                        <span class="text-muted">Not Assigned</span>
                                                    </ng-template>
                                                </td>
                                                <td class="col-manual-tester">
                                                    <div *ngIf="testCase.manualTesterName; else noManualTester">
                                                        <span class="fw-semibold">{{ testCase.manualTesterName }}</span>
                                                    </div>
                                                    <ng-template #noManualTester>
                                                        <span class="text-muted">Not Assigned</span>
                                                    </ng-template>
                                                </td>
                                                <td class="col-type">
                                                    <span *ngIf="testCase.testCaseType" class="badge bg-info">{{ testCase.testCaseType }}</span>
                                                    <span *ngIf="!testCase.testCaseType" class="text-muted">-</span>
                                                </td>
                                                <td class="col-tool">
                                                    <span *ngIf="testCase.toolType" class="badge bg-secondary">{{ testCase.toolType }}</span>
                                                    <span *ngIf="!testCase.toolType" class="text-muted">-</span>
                                                </td>
                                                <td class="col-domain">
                                                    <span *ngIf="testCase.domainMapped" class="badge bg-dark">{{ testCase.domainMapped }}</span>
                                                    <span *ngIf="!testCase.domainMapped" class="text-muted">-</span>
                                                </td>
                                                <td class="col-jira">
                                                    <div *ngIf="testCase.relatedJiraKey; else noJira">
                                                        <span class="badge bg-primary">{{ testCase.relatedJiraKey }}</span>
                                                    </div>
                                                    <ng-template #noJira><span class="text-muted">-</span></ng-template>
                                                </td>
                                                <td *ngIf="showTestCaseOptions" class="col-actions">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button (click)="openStatisticsTestCaseModal(testCase)"
                                                                [disabled]="loading"
                                                                class="btn btn-outline-primary btn-sm" title="Edit/Map Test Case">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button (click)="viewTestCaseDetails(testCase)"
                                                                class="btn btn-outline-info btn-sm"
                                                                title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <ng-template #noStatisticsTestCases>
                                        <div class="no-data py-4">
                                            <i class="fas fa-clipboard-list text-muted mb-3"></i>
                                            <h6 class="text-muted">No test cases found</h6>
                                            <p class="text-muted small">
                                                {{ statisticsSearchTerm || statisticsStatusFilter ||
                                                statisticsProjectFilter ? "No test cases match your filter criteria" :
                                                "No test cases available for this sprint" }}
                                            </p>
                                        </div>
                                    </ng-template>

                                    <!-- Statistics Pagination -->
                                    <div *ngIf="statisticsTotalPages > 1"
                                         class="d-flex justify-content-between align-items-center p-3">
                                        <div class="text-muted small">
                                            Showing {{ (statisticsCurrentPage - 1) * statisticsItemsPerPage + 1 }} to {{
                                            Math.min(statisticsCurrentPage * statisticsItemsPerPage,
                                            filteredStatisticsTestCases.length) }} of {{
                                            filteredStatisticsTestCases.length }} test cases
                                        </div>
                                        <nav>
                                            <ul class="pagination pagination-sm mb-0">
                                                <li [class.disabled]="statisticsCurrentPage === 1" class="page-item">
                                                    <a (click)="goToStatisticsPage(statisticsCurrentPage - 1)"
                                                       class="page-link"
                                                       style="cursor: pointer">Previous</a>
                                                </li>
                                                <li *ngFor="let page of [].constructor(statisticsTotalPages); let i = index"
                                                    [class.active]="statisticsCurrentPage === i + 1"
                                                    class="page-item">
                                                    <a (click)="goToStatisticsPage(i + 1)" class="page-link"
                                                       style="cursor: pointer">{{ i + 1 }}</a>
                                                </li>
                                                <li [class.disabled]="statisticsCurrentPage === statisticsTotalPages"
                                                    class="page-item">
                                                    <a (click)="goToStatisticsPage(statisticsCurrentPage + 1)"
                                                       class="page-link"
                                                       style="cursor: pointer">Next</a>
                                                </li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- NEW: Statistics Test Case Edit Modal -->
<p-dialog
        [(visible)]="showStatisticsTestCaseModal"
        [blockScroll]="true"
        [closable]="true"
        [closeOnEscape]="false"
        [dismissableMask]="false"
        [modal]="true"
        [resizable]="true"
        [style]="{
    width: '90vw',
    maxWidth: '1200px',
    height: '90vh',
    maxHeight: '800px'
  }"
        appendTo="body"
        header="Edit Test Case - Statistics View"
>
    <div
            *ngIf="selectedStatisticsTestCase"
            class="test-case-modal-content"
    >
        <div class="row g-3">
            <div class="col-lg-6">
                <h6 class="text-primary">Test Case Information</h6>
                <div class="info-card">
                    <p><strong>Title:</strong> {{ selectedStatisticsTestCase.qtestTitle }}</p>
                    <p>
                        <strong>QTest ID:</strong> {{ selectedStatisticsTestCase.qtestId || "N/A" }}
                    </p>
                    <p>
                        <strong>Current Status:</strong>
                        <span
                                [class]="
                getAutomationStatusColor(selectedStatisticsTestCase.automationStatus)
              "
                                class="badge"
                        >
              {{
                getAutomationStatusDisplay(selectedStatisticsTestCase.automationStatus)
              }}
            </span>
                    </p>

                    <!-- Enhanced Test Case Information Section with Dropdowns -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-secondary">Update Test Case Information</h6>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-12">
                            <label class="form-label" for="statisticsTestCaseProject"
                            ><strong>Project:</strong></label
                            >
                            <select
                                    [(ngModel)]="selectedStatisticsTestCaseProject"
                                    class="form-select form-select-sm"
                                    id="statisticsTestCaseProject"
                            >
                                <option [ngValue]="null">Select Project</option>
                                <option *ngFor="let project of projects" [ngValue]="project">
                                    {{ project.name }} ({{ project.domain?.name }})
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <label class="form-label" for="statisticsTestCaseTester"
                            ><strong>Assigned Tester:</strong></label
                            >
                            <select
                                    [(ngModel)]="selectedStatisticsTestCaseTester"
                                    class="form-select form-select-sm"
                                    id="statisticsTestCaseTester"
                            >
                                <option [ngValue]="null">Select Tester</option>
                                <option *ngFor="let tester of testers" [ngValue]="tester">
                                    {{ tester.name }} ({{ tester.role }})
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <label class="form-label" for="statisticsTestCaseDomain"
                            ><strong>Domain:</strong></label
                            >
                            <select
                                    [(ngModel)]="selectedStatisticsTestCaseDomain"
                                    class="form-select form-select-sm"
                                    id="statisticsTestCaseDomain"
                            >
                                <option [ngValue]="null">Select Domain</option>
                                <option *ngFor="let domain of domains" [ngValue]="domain">
                                    {{ domain.name }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <label class="form-label" for="statisticsTestCaseType">
                                <strong>Test Case Type:</strong>
                            </label>
                            <select
                                    [(ngModel)]="selectedStatisticsTestCaseType"
                                    class="form-select form-select-sm"
                                    id="statisticsTestCaseType"
                            >
                                <option [ngValue]="null">Select Type</option>
                                <option value="API">API</option>
                                <option value="UI">UI</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label" for="statisticsToolType">
                                <strong>Tool Type:</strong>
                            </label>
                            <select
                                    [(ngModel)]="selectedStatisticsToolType"
                                    class="form-select form-select-sm"
                                    id="statisticsToolType"
                            >
                                <option [ngValue]="null">Select Tool</option>
                                <option value="Selenium">Selenium</option>
                                <option value="Tosca">Tosca</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <label class="form-label" for="statisticsManualTesterId">
                                <strong>Manual Tester:</strong>
                            </label>
                            <select
                                    [(ngModel)]="selectedStatisticsManualTesterId"
                                    class="form-select form-select-sm"
                                    id="statisticsManualTesterId"
                            >
                                <option [ngValue]="null">Select Manual Tester</option>
                                <option *ngFor="let tester of testers" [ngValue]="tester.id">
                                    {{ tester.name }} ({{ tester.role }})
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Display current values -->
                    <div class="current-values mt-3">
                        <small class="text-muted">
                            <strong>Current Values:</strong><br/>
                            Project: {{ selectedStatisticsTestCase.projectName || "Not mapped" }}<br/>
                            Tester: {{ selectedStatisticsTestCase.assignedTesterName || "Not assigned"
                            }}<br/>
                            Domain: {{ selectedStatisticsTestCase.domainMapped || "N/A" }}<br/>
                            Test Case Type:
                            {{ selectedStatisticsTestCase.testCaseType || "Not specified" }}<br/>
                            Tool Type: {{ selectedStatisticsTestCase.toolType || "Not specified"
                            }}<br/>
                            Manual Tester:
                            {{ selectedStatisticsTestCase.manualTesterName || "Not assigned" }}
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <h6 class="text-primary">Related Jira Issue</h6>
                <div *ngIf="selectedStatisticsTestCase.relatedJiraKey" class="info-card">
                    <p><strong>Key:</strong> {{ selectedStatisticsTestCase.relatedJiraKey }}</p>
                    <p><strong>Summary:</strong> {{ selectedStatisticsTestCase.relatedJiraSummary }}</p>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>This test case is linked to the above JIRA issue. Any automation status changes will be
                            reflected in the related issue.</small>
                    </div>
                </div>
                <div *ngIf="!selectedStatisticsTestCase.relatedJiraKey" class="info-card">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>This test case is not currently linked to any JIRA issue.</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <h6 class="text-primary">Automation Assessment</h6>
                <div class="automation-controls">
                    <div class="form-check form-check-inline automation-radio">
                        <input
                                (change)="onStatisticsAutomationStatusChange('can_automate')"
                                [checked]="selectedStatisticsTestCase.canBeAutomated === true"
                                [value]="true"
                                class="form-check-input"
                                id="statisticsCanAutomate"
                                name="statisticsAutomationChoice"
                                type="radio"
                        />
                        <label class="form-check-label text-success" for="statisticsCanAutomate">
                            <i class="fas fa-check me-1"></i>
                            Can be Automated
                        </label>
                    </div>
                    <div class="form-check form-check-inline automation-radio">
                        <input
                                (change)="onStatisticsAutomationStatusChange('cannot_automate')"
                                [checked]="selectedStatisticsTestCase.cannotBeAutomated === true"
                                [value]="true"
                                class="form-check-input"
                                id="statisticsCannotAutomate"
                                name="statisticsAutomationChoice"
                                type="radio"
                        />
                        <label class="form-check-label text-danger" for="statisticsCannotAutomate">
                            <i class="fas fa-times me-1"></i>
                            Cannot be Automated
                        </label>
                    </div>
                    <div class="form-check form-check-inline automation-radio">
                        <input
                                (change)="onStatisticsAutomationStatusChange('pending')"
                                [checked]="
                !selectedStatisticsTestCase.canBeAutomated &&
                !selectedStatisticsTestCase.cannotBeAutomated
              "
                                [value]="true"
                                class="form-check-input"
                                id="statisticsPending"
                                name="statisticsAutomationChoice"
                                type="radio"
                        />
                        <label class="form-check-label text-warning" for="statisticsPending">
                            <i class="fas fa-clock me-1"></i>
                            Pending Assessment
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="d-flex justify-content-between w-100">
            <button (click)="closeStatisticsTestCaseModal()" class="btn btn-secondary">
                <i class="fas fa-times me-1"></i>
                Close
            </button>
            <button
                    (click)="saveStatisticsTestCaseInformation()"
                    [disabled]="loading || !hasStatisticsTestCaseChanges()"
                    class="btn btn-success"
            >
        <span
                *ngIf="loading"
                class="spinner-border spinner-border-sm me-2"
        ></span>
                <i *ngIf="!loading" class="fas fa-save me-1"></i>
                {{ loading ? "Saving..." : "Save Changes" }}
            </button>
        </div>
    </ng-template>
</p-dialog>

<!-- NEW: Test Case Details View Modal -->
<p-dialog
        [(visible)]="showTestCaseDetailsModal"
        [blockScroll]="true"
        [closable]="true"
        [closeOnEscape]="true"
        [dismissableMask]="true"
        [modal]="true"
        [style]="{
    width: '80vw',
    maxWidth: '900px',
    height: 'auto',
    maxHeight: '80vh'
  }"
        appendTo="body"
        header="Test Case Details"
>
    <div
            *ngIf="selectedDetailsTestCase"
            class="test-case-details-content"
    >
        <div class="row g-3">
            <div class="col-md-6">
                <h6 class="text-primary">Basic Information</h6>
                <div class="details-card">
                    <div class="detail-item">
                        <strong>Title:</strong>
                        <span>{{ selectedDetailsTestCase.qtestTitle }}</span>
                    </div>
                    <div class="detail-item">
                        <strong>QTest ID:</strong>
                        <span>{{ selectedDetailsTestCase.qtestId || "N/A" }}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Automation Status:</strong>
                        <span
                                [class]="getAutomationStatusColor(selectedDetailsTestCase.automationStatus)"
                                class="badge ms-2"
                        >
              {{ getAutomationStatusDisplay(selectedDetailsTestCase.automationStatus) }}
            </span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Assignment & Mapping</h6>
                <div class="details-card">
                    <div class="detail-item">
                        <strong>Project:</strong>
                        <span>{{ selectedDetailsTestCase.projectName || "Not mapped" }}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Domain:</strong>
                        <span>{{ selectedDetailsTestCase.domainMapped || "Not mapped" }}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Assigned Tester:</strong>
                        <span>{{ selectedDetailsTestCase.assignedTesterName || "Not assigned" }}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Manual Tester:</strong>
                        <span>{{ selectedDetailsTestCase.manualTesterName || "Not assigned" }}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Test Case Type:</strong>
                        <span>{{ selectedDetailsTestCase.testCaseType || "Not specified" }}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Tool Type:</strong>
                        <span>{{ selectedDetailsTestCase.toolType || "Not specified" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div *ngIf="selectedDetailsTestCase.relatedJiraKey" class="row mt-3">
            <div class="col-12">
                <h6 class="text-primary">Related JIRA Issue</h6>
                <div class="details-card">
                    <div class="detail-item">
                        <strong>JIRA Key:</strong>
                        <span class="badge bg-primary ms-2">{{ selectedDetailsTestCase.relatedJiraKey }}</span>
                    </div>
                    <div *ngIf="selectedDetailsTestCase.relatedJiraSummary" class="detail-item">
                        <strong>Summary:</strong>
                        <span>{{ selectedDetailsTestCase.relatedJiraSummary }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="d-flex justify-content-end">
            <button (click)="closeTestCaseDetailsModal()" class="btn btn-secondary me-2">
                <i class="fas fa-times me-1"></i>
                Close
            </button>
            <button
                    (click)="editFromDetailsView()"
                    *ngIf="showTestCaseOptions"
                    class="btn btn-primary"
            >
                <i class="fas fa-edit me-1"></i>
                Edit Test Case
            </button>
        </div>
    </ng-template>
</p-dialog>


<!-- Remaining modals stay the same as in the original -->
<!-- Test Case Modal -->
<p-dialog
        [(visible)]="showTestCaseModal"
        [blockScroll]="true"
        [closable]="true"
        [closeOnEscape]="false"
        [dismissableMask]="false"
        [modal]="true"
        [resizable]="true"
        [style]="{
    width: '90vw',
    maxWidth: '1200px',
    height: '90vh',
    maxHeight: '800px'
  }"
        appendTo="body"
        header="Test Case Details"
>
    <div
            *ngIf="selectedTestCase && selectedIssue"
            class="test-case-modal-content"
    >
        <div class="row g-3">
            <div class="col-lg-6">
                <h6 class="text-primary">Test Case Information</h6>
                <div class="info-card">
                    <p><strong>Title:</strong> {{ selectedTestCase.qtestTitle }}</p>
                    <p>
                        <strong>QTest ID:</strong> {{ selectedTestCase.qtestId || "N/A" }}
                    </p>
                    <p>
                        <strong>Current Status:</strong>
                        <span
                                [class]="
                getAutomationStatusColor(selectedTestCase.automationStatus)
              "
                                class="badge"
                        >
              {{
                getAutomationStatusDisplay(selectedTestCase.automationStatus)
              }}
            </span>
                    </p>

                    <!-- Enhanced Test Case Information Section with Dropdowns -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-secondary">Update Test Case Information</h6>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-12">
                            <label class="form-label" for="testCaseProject"
                            ><strong>Project:</strong></label
                            >
                            <select
                                    [(ngModel)]="selectedTestCaseProject"
                                    class="form-select form-select-sm"
                                    id="testCaseProject"
                            >
                                <option [ngValue]="null">Select Project</option>
                                <option *ngFor="let project of projects" [ngValue]="project">
                                    {{ project.name }} ({{ project.domain?.name }})
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <label class="form-label" for="testCaseTester"
                            ><strong>Assigned Tester:</strong></label
                            >
                            <select
                                    [(ngModel)]="selectedTestCaseTester"
                                    class="form-select form-select-sm"
                                    id="testCaseTester"
                            >
                                <option [ngValue]="null">Select Tester</option>
                                <option *ngFor="let tester of testers" [ngValue]="tester">
                                    {{ tester.name }} ({{ tester.role }})
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <label class="form-label" for="testCaseDomain"
                            ><strong>Domain:</strong></label
                            >
                            <select
                                    [(ngModel)]="selectedTestCaseDomain"
                                    class="form-select form-select-sm"
                                    id="testCaseDomain"
                            >
                                <option [ngValue]="null">Select Domain</option>
                                <option *ngFor="let domain of domains" [ngValue]="domain">
                                    {{ domain.name }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <label class="form-label" for="testCaseType">
                                <strong>Test Case Type:</strong>
                            </label>
                            <select
                                    [(ngModel)]="selectedTestCaseType"
                                    class="form-select form-select-sm"
                                    id="testCaseType"
                            >
                                <option [ngValue]="null">Select Type</option>
                                <option value="API">API</option>
                                <option value="UI">UI</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label" for="toolType">
                                <strong>Tool Type:</strong>
                            </label>
                            <select
                                    [(ngModel)]="selectedToolType"
                                    class="form-select form-select-sm"
                                    id="toolType"
                            >
                                <option [ngValue]="null">Select Tool</option>
                                <option value="Selenium">Selenium</option>
                                <option value="Tosca">Tosca</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-12">
                            <label class="form-label" for="manualTesterId">
                                <strong>Manual Tester:</strong>
                            </label>
                            <select
                                    [(ngModel)]="selectedManualTesterId"
                                    class="form-select form-select-sm"
                                    id="manualTesterId"
                            >
                                <option [ngValue]="null">Select Manual Tester</option>
                                <option *ngFor="let tester of testers" [ngValue]="tester.id">
                                    {{ tester.name }} ({{ tester.role }})
                                </option>
                            </select>
                        </div>
                    </div>
                    <!-- Display current values -->
                    <div class="current-values mt-3">
                        <small class="text-muted">
                            <strong>Current Values:</strong><br/>
                            Project: {{ selectedTestCase.projectName || "Not mapped" }}<br/>
                            Tester: {{ selectedTestCase.assignedTesterName || "Not assigned"
                            }}<br/>
                            Domain: {{ selectedTestCase.domainMapped || "N/A" }}<br/>
                            Test Case Type:
                            {{ selectedTestCase.testCaseType || "Not specified" }}<br/>
                            Tool Type: {{ selectedTestCase.toolType || "Not specified"
                            }}<br/>
                            Manual Tester:
                            {{ selectedTestCase.manualTesterName || "Not assigned" }}
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <h6 class="text-primary">Related Jira Issue</h6>
                <div class="info-card">
                    <p><strong>Key:</strong> {{ selectedIssue.jiraKey }}</p>
                    <p><strong>Summary:</strong> {{ selectedIssue.summary }}</p>
                    <p>
                        <strong>Status:</strong>
                        <span [class]="getStatusColor(selectedIssue.status)" class="badge">
              {{ selectedIssue.status }}
            </span>
                    </p>
                    <p>
                        <strong>Priority:</strong>
                        <span
                                [class]="getPriorityColor(selectedIssue.priority)"
                                class="badge"
                        >
              {{ selectedIssue.priority }}
            </span>
                    </p>
                    <p>
                        <strong>Assignee:</strong>
                        {{ selectedIssue.assigneeDisplayName || "Unassigned" }}
                    </p>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <h6 class="text-primary">Automation Assessment</h6>
                <div class="automation-controls">
                    <div class="form-check form-check-inline automation-radio">
                        <input
                                (change)="onAutomationStatusChange('can_automate')"
                                [checked]="selectedTestCase.canBeAutomated === true"
                                [value]="true"
                                class="form-check-input"
                                id="canAutomate"
                                name="automationChoice"
                                type="radio"
                        />
                        <label class="form-check-label text-success" for="canAutomate">
                            <i class="fas fa-check me-1"></i>
                            Can be Automated
                        </label>
                    </div>
                    <div class="form-check form-check-inline automation-radio">
                        <input
                                (change)="onAutomationStatusChange('cannot_automate')"
                                [checked]="selectedTestCase.cannotBeAutomated === true"
                                [value]="true"
                                class="form-check-input"
                                id="cannotAutomate"
                                name="automationChoice"
                                type="radio"
                        />
                        <label class="form-check-label text-danger" for="cannotAutomate">
                            <i class="fas fa-times me-1"></i>
                            Cannot be Automated
                        </label>
                    </div>
                    <div class="form-check form-check-inline automation-radio">
                        <input
                                (change)="onAutomationStatusChange('pending')"
                                [checked]="
                !selectedTestCase.canBeAutomated &&
                !selectedTestCase.cannotBeAutomated
              "
                                [value]="true"
                                class="form-check-input"
                                id="pending"
                                name="automationChoice"
                                type="radio"
                        />
                        <label class="form-check-label text-warning" for="pending">
                            <i class="fas fa-clock me-1"></i>
                            Pending Assessment
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="d-flex justify-content-between w-100">
            <button (click)="closeTestCaseModal()" class="btn btn-secondary">
                <i class="fas fa-times me-1"></i>
                Close
            </button>
            <button
                    (click)="saveTestCaseInformation()"
                    [disabled]="loading || !hasTestCaseChanges()"
                    class="btn btn-success"
            >
        <span
                *ngIf="loading"
                class="spinner-border spinner-border-sm me-2"
        ></span>
                <i *ngIf="!loading" class="fas fa-save me-1"></i>
                {{ loading ? "Saving..." : "Save Changes" }}
            </button>
        </div>
    </ng-template>
</p-dialog>

<!-- Keyword Search Modal -->
<p-dialog
        [(visible)]="showKeywordModal"
        [modal]="true"
        [style]="{ width: '40rem' }"
        appendTo="body"
        header="Search Keywords in Comments"
>
    <div *ngIf="selectedIssue">
        <div class="row">
            <div class="col-12 mb-3">
                <h6 class="text-primary">Issue: {{ selectedIssue.jiraKey }}</h6>
                <p class="text-muted">{{ selectedIssue.summary }}</p>
                <p *ngIf="selectedIssue.keywordCount > 0" class="small text-info">
                    Previous search found {{ selectedIssue.keywordCount }} occurrences
                    <span *ngIf="selectedIssue.searchKeyword">
            of "{{ selectedIssue.searchKeyword }}"
          </span>
                </p>
            </div>
        </div>

        <form (ngSubmit)="searchKeyword()" [formGroup]="keywordSearchForm">
            <div class="row">
                <div class="col-12">
                    <div class="mb-3">
                        <label class="form-label" for="keyword">Keyword to Search</label>
                        <input
                                [class.is-invalid]="
                keywordSearchForm.get('keyword')?.invalid &&
                keywordSearchForm.get('keyword')?.touched
              "
                                class="form-control"
                                formControlName="keyword"
                                id="keyword"
                                placeholder="Enter keyword (e.g., 'observation', 'bug', 'issue')"
                                type="text"
                        />
                        <div
                                *ngIf="
                keywordSearchForm.get('keyword')?.invalid &&
                keywordSearchForm.get('keyword')?.touched
              "
                                class="invalid-feedback"
                        >
                            Please enter a keyword with at least 3 characters.
                        </div>
                        <div class="form-text">
                            Search will look through all comments in this Jira issue for the
                            specified keyword.
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <ng-template pTemplate="footer">
        <button (click)="closeKeywordModal()" class="btn btn-secondary me-2">
            Cancel
        </button>
        <button
                (click)="searchKeyword()"
                [disabled]="!keywordSearchForm.valid || loading"
                class="btn btn-primary"
        >
      <span
              *ngIf="loading"
              class="spinner-border spinner-border-sm me-2"
      ></span>
            <i *ngIf="!loading" class="fas fa-search me-2"></i>
            {{ loading ? "Searching..." : "Search Comments" }}
        </button>
    </ng-template>
</p-dialog>
